<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"global.html":{"id":"global.html","title":"Global","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Global Type Definitions libCB(err, data) Parameters: Name Type Description err object mongojs error data object mongojs resultado × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"modules.list.html":{"id":"modules.list.html","title":"Modules","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Modules Classes Filter HotelCtrl Hotels HotelsDB Sales SalesCtrl SalesDB Sorting Statics ThemesDB × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Classes Classes Filter HotelCtrl Hotels HotelsDB Sales SalesCtrl SalesDB Sorting Statics ThemesDB × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"index.html":{"id":"index.html","title":"Index","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global API Reservalia Esta API provee acceso a los datos y funcionalidades de Reservalia. Dependecies { &quot;argsparser&quot;: &quot;0.0.7&quot;, &quot;authtoken&quot;: &quot;*&quot;, &quot;boom&quot;: &quot;^3.1.2&quot;, &quot;config&quot;: &quot;^1.20.1&quot;, &quot;debug&quot;: &quot;^2.2.0&quot;, &quot;good&quot;: &quot;^6.6.0&quot;, &quot;good-console&quot;: &quot;^5.3.1&quot;, &quot;hapi&quot;: &quot;^13.2.1&quot;, &quot;hapi-api-version&quot;: &quot;^1.0.2&quot;, &quot;hapi-swaggered&quot;: &quot;^2.6.0&quot;, &quot;hapi-swaggered-ui&quot;: &quot;^2.3.1&quot;, &quot;inert&quot;: &quot;^3.2.0&quot;, &quot;joi&quot;: &quot;^8.0.4&quot;, &quot;mongojs&quot;: &quot;^2.3.0&quot;, &quot;newrelic&quot;: &quot;^1.26.0&quot;, &quot;redis-sentinel&quot;: &quot;^0.3.3&quot;, &quot;vision&quot;: &quot;^4.0.1&quot; }Project Layout routes (endpoints de API con HAPI) controllers (Lógica y validaciones. Desacoplado de Hapi) lib (Acceso a DB - Mongojs) prototypes (Librerias con prototypes para endpoints, controllers y libs) filters (lógica para filters) sorting (lógica para ordenamiento) tests (test unitarios con mocha) config (json con la configuración por ambiente) envs (configuración por ambiente, se migrará todo a config) public (contiene la documentación de jsdoc, se corre con gulp) scripts (script bash para correr en diferentes ambientes) Request pasa por estas 3 capas, en ese orden. Routes (Hapi) Controllers (Lógica) Lib (Acceso a DB) Cada capa usa un el prototype (prototype o clase padre) correspondiente Routes =&gt; prototypes/Endpoint.js Controllers =&gt; prototypes/Controller.js Lib =&gt; prototypes/Lib.js Si creo una Lib que necesita acceder a la DB tengo que extender de prototypes/Lib.js &quot;use strict&quot;; const DB = &quot;checkout&quot;; const debug = require(&quot;debug&quot;)(&quot;API&quot;); const Lib = require(&quot;../prototypes/Lib&quot;); /** * SalesDB es una lib que accede a la base de datos que contiene los hotels de reservalia. * * SalesDB pertence a la capa lib y como tal debe extender del prototype Lib. * * Cada Lib tiene acceso a acceder a cualquier db dentro del sistema. * * @class * @returns {{getSales: (function(*, *=, *=, *=)), getSalesByHotelId: (function(*, *=, *=, *=))}} * */ class SalesDB extends Lib{ //Insert methods here }Si creo un controller, debo pisar el prototype por el momento(se cambiará a prototypes o class) HotelCtrl.prototype = require(&quot;../prototypes/Controller.js&quot;); module.exports = new HotelCtrl();Lo mismo ocurre con routes Hotels.prototype = require(&quot;../prototypes/Endpoint.js&quot;); module.exports = Hotels;Para crear un endpoint (una ruta de API) tengo que tener en cuenta la config de swagger. Para esto se agregó el método buildConfig, que recibe la config que necesita swagger para dibujar el endpoint y a su vez validar el input. server.route({ method: 'GET', path: '/v1/hotels/{hotelId}', config: Hotels.prototype.buildConfig({ params: { // Tiene que coincidir el Path Param con el params del objeto Validate. hotelId: Joi.number().required().description('Hotel ID from PAM') }, query:{ filter: Joi.string().description(&quot;Filter Options: TODO put fields here. If you don't put anything, by default API retrieves you the reduce version of sale&quot;), reduce: Joi.boolean().description(&quot;Reduce version of Hotel&quot;) } },statusCodes['/v1/hotels/{hotelId}']), handler: function (req, reply) { let params = { hotelId: req.params.hotelId, filter:req.query.filter, reduce: req.query.reduce }; hotels.getHotelById( params,(err,hotel) =&gt; Response.do( reply, err, hotel ,'/v1/hotels/{hotelId}') ); } });Como se ve, handler recibe req y reply. La librería Response valida la respuesta. Es obligatorio llamar a Response.do para devolver los request porque genera los headers. La idea es que el endpoint no tenga lógica y sea lo mas compacto posible, de esta manera podemos desacoplarnos y utilizar la herramienta que queramos y podemos testear por separado. El handler llama al controller hotels.getHotelById(...)Veamos el método gethotelById en hotelsController.js getHotelById(params,cb){ if(typeof params.filter !== &quot;undefined&quot;){ params.filter += &quot;,id,name&quot;;//Require Fields -&gt; cambiar no me gusta } let filters = _this.getFilter(mapFilter,params.filter); let sort = _this.getSort(mapSorting,params.sort); Promise.all([ hotels.getHotelById(params,filters,sort), themes.getColors() ]).then(function onFullFilled(responses){ let hotelRaw = responses.shift(); let colors = responses.shift(); return cb(null,buildHotel({ hotelRaw,colors})); }).catch(function onRejected(err){ console.log(err); return cb(Errors.noHotel,null); }); },Ejecuta una serie de request dentro de una Promise. Cuando termina, se arma el buildHotel y se llama al callback. En un futuro se cambiará a Promise La Promise hacen llamados a métodos de lib/. Veamos getHotelById en /lib/hotelsDB.js getHotelById(params,filters,sorting){ return new Promise( (resolve,reject)=&gt;{ if(typeof params.limit != &quot;undefined&quot; &amp;&amp; params.limit &gt; 0 &amp;&amp; typeof params.offset != &quot;undefined&quot; &amp;&amp; params.offset &gt; -1){ let skip = params.offset * params.limit; super.getDB().config.findOne({ _id: &quot;&quot;+params.hotelId},filters).skip(skip).limit(params.limit,(err,result)=&gt;{ err ? reject(err) : resolve(result); }); }else{ super.getDB().config.findOne({ _id: &quot;&quot;+params.hotelId},filters,(err,result)=&gt;{ err ? reject(err) : resolve(result); }); } }); }getHotelById devuelve una Promise en base al callback de mongojs. Tiene en cuenta los filtros y ordenamiento. Así es el flujo de un request en API. Puede que en el medio haya lógica de ordenamiento y filtrado con código sincrónico. × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"Filter.html":{"id":"Filter.html","title":"Class: Filter","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: Filter Filter new Filter(map, filters) Devuelve una function que convierte los path/query params de API a un objeto para ordenar en mongo. Parameters: Name Type Description map Object.&lt;string, string&gt; key value de API - Mongo Property filters Object.&lt;string, string&gt; Params del request Returns: object para mongodb filter. Type Object.&lt;string, number&gt; × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"HotelCtrl.html":{"id":"HotelCtrl.html","title":"Class: HotelCtrl","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: HotelCtrl HotelCtrl new HotelCtrl() HotelCtrl es un controller que maneja la lógica de los objetos de hotels. Cada controller posee libs asociadas que permiten acceder a la base de datos u otros servicios. HotelCtrl pertenece a la capa controllers, cada vez que creo un objeto en la capa controllers, tengo que setear quien es su prototipo. Utilizando utils.inherits(MiClase,Prototype). Luego exportar el objeto, en este caso HotelCtrl Returns: Type Object Members &lt;inner&gt; mapFilter :Object Type: Object &lt;inner&gt; mapSorting :Object Type: Object Methods &lt;static&gt; getHotelById(params, cb) Retorna un hotel por ID teniendo en cuenta los filtros, ordenamiento y parámetros. Parameters: Name Type Description params object cb HotelCtrl~getHotelById &lt;static&gt; getHotels(params, cb) Retorna todos los hotels teniendo en cuenta los filtros, ordenamiento y parámetros. Parameters: Name Type Description params object cb HotelCtrl~getHotels &lt;static&gt; getHotelsOnline(params, cb) Retorna solo los hoteles online.(online: true) teniendo en cuenta los filtros, ordenamientos y paramétros. Parameters: Name Type Description params object cb HotelCtrl~getHotelsOnline &lt;inner&gt; buildHotel(hotelRaw) Transforma un hotel de la base de datos al hotel que viaja en el response. Parameters: Name Type Description hotelRaw Objeto tal cual viene de la base de datos. Returns: Type Object Type Definitions getHotelById(err, sales) Parameters: Name Type Description err object sales Array getHotels(err, sales) Parameters: Name Type Description err object sales Array getHotelsOnline(err, sales) Parameters: Name Type Description err object sales Array × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"Hotels.html":{"id":"Hotels.html","title":"Class: Hotels","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: Hotels Hotels new Hotels(server) Hotels contiene los endpoints de /hotels Cada endpoint tiene como referencia uno o mas controller que continen la lógica para armar los responses. Hotels pertenece a la capa routes, cada vez que creo un objeto en la capa routes, tengo que setear quien es su prototipo. Utilizando utils.inherits(MiClase,Prototype). Luego exportar el objeto, en este caso Hotels Parameters: Name Type Description server Hapi Server × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"HotelsDB.html":{"id":"HotelsDB.html","title":"Class: HotelsDB","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: HotelsDB HotelsDB new HotelsDB() Returns: Type Object Methods &lt;static&gt; ThemesDB#getColors() Retorna todos los colores de los themes &lt;static&gt; ThemesDB#getThemes() Retorna todos los themes getHotelById(params, filters, sorting, cb) Retorna un hotel por id Parameters: Name Type Description params object Contiene el id del hotel y filtros. filters boject Filtros de mongo: {lastModified:1} sorting object Sorting de mongo: {total_price:-1} cb libCB callback getHotels(params, filters, sorting, cb) Retorna todos los hotels teniendo en cuenta los parámetros, filtrado y ordenamiento Parameters: Name Type Description params object contiene limit y offset obligatoriamente. filters object Filtros de mongo: {lastModified:1} sorting object Sorting de mongo: {total_price:-1} cb libCB callback getHotelsOnline(params, filters, sorting, cb) Retorna todos los hotels ONLINE teniendo en cuenta los parámetros, filtrado y ordenamiento Parameters: Name Type Description params object contiene limit y offset obligatoriamente. filters object Filtros de mongo: {lastModified:1} sorting object Sorting de mongo: {total_price:-1} cb libCB callback × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"module-config.html":{"id":"module-config.html","title":"Module: config","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Module: config Este script corre al inicio del server. Según el ambiente en donde se configura, posee diferentes archivos config que se encuentran en /envs. Para variar de ambiente, utilizar la variable de entorno NODE_ENV Default dev. × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"module-Controller.html":{"id":"module-Controller.html","title":"Module: Controller","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Module: Controller Prototype base para todos los controllers Para implementar utilizar utils.inherits(MyCtrl,Controller); Members &lt;inner, constant&gt; Filter &lt;inner, constant&gt; Sorting Methods &lt;inner&gt; getFilter(map, filters) Convierte los path/query params de API a un objeto para ordenar en mongo. Parameters: Name Type Description map object key value de API - Mongo Property filters object Params del request Returns: key value for mongodb. Type object &lt;inner&gt; getSort(map, params) Convierte los path/query params de API a un objeto para ordenar en mongo. Parameters: Name Type Description map object key value de API - Mongo Property params object Params del request Returns: key value for mongodb. Type object × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"module-Endpoint.html":{"id":"module-Endpoint.html","title":"Module: Endpoint","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Module: Endpoint Prototype base para todos los Endpoints Para implementar utilizar Example utils.inherits(MyEndpoint,Endpoint); Methods &lt;inner&gt; buildConfig(validate) BuildConfig es obligatorio en cada endpoint si se quiere validar los path/query params, y si se quiere agregar a swagger Parameters: Name Type Description validate object Joi schema Returns: Type Object × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"module-Lib.html":{"id":"module-Lib.html","title":"Module: Lib","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Module: Lib Prototype base para todas las Lib que quieran acceder a la base de datos. Para implementar utilizar Example utils.inherits(MyLib,Lib); × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"module-newrelic.html":{"id":"module-newrelic.html","title":"Module: newrelic","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Module: newrelic New Relic agent configuration. See lib/config.defaults.js in the agent distribution for a more complete description of configuration variables and their potential values. × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"Sales.html":{"id":"Sales.html","title":"Class: Sales","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: Sales Sales new Sales(server) Sales contiene los endpoints de /sales. Cada endpoint tiene como referencia uno o mas controller que continen la lógica para armar los responses. Sales pertenece a la capa routes, cada vez que creo un objeto en la capa routes, tengo que setear quien es su prototipo. Utilizando utils.inherits(MiClase,Prototype). Luego exportar el objeto, en este caso Sales Parameters: Name Type Description server object Hapi Server × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"SalesCtrl.html":{"id":"SalesCtrl.html","title":"Class: SalesCtrl","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: SalesCtrl SalesCtrl new SalesCtrl() SalesCtrl es un controller que maneja la lógica de los objetos de hotels. Cada controller posee libs asociadas que permiten acceder a la base de datos u otros servicios. SalesCtrl pertenece a la capa controllers, cada vez que creo un objeto en la capa controllers, tengo que setear quien es su prototipo. Utilizando utils.inherits(MiClase,Prototype). Luego exportar el objeto, en este caso SalesCtrl Returns: Type Object Methods &lt;static&gt; getSales(params, cb) Retorna todas las ventas de forma paginada teniendo en cuenta los filtros, ordenamientos y parámetros. Parameters: Name Type Description params object cb SalesCtrl~getSalesDB &lt;static&gt; getSalesByHotelId(params, cb) Retorna todas las ventas de un hotel en particular teniendo en cuenta los filtros, ordenamientos y parámetros. Parameters: Name Type Description params object cb SalesCtrl~getSalesCBByHotelId Type Definitions getSalesCB(err, sales) Parameters: Name Type Description err object sales Array getSalesCBByHotelId(err, sales) Parameters: Name Type Description err object sales Array × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"SalesDB.html":{"id":"SalesDB.html","title":"Class: SalesDB","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: SalesDB SalesDB SalesDB es una lib que accede a la base de datos que contiene los hotels de reservalia. SalesDB pertence a la capa lib y como tal debe extender del prototype Lib. Cada Lib tiene acceso a acceder a cualquier db dentro del sistema. new SalesDB() Returns: Type Object Methods getSales(params, filters, sorting, cb) Retorna todas las ventas teniendo en cuenta los filtros y ordenamiento. Parameters: Name Type Description params object contiene limit y offset obligatoriamente. filters object Filtros de mongo: {lastModified:1} sorting object Sorting de mongo: {lastModified:-1} cb libCB retorna un array de ventas. getSalesByHotelId(params, filters, sorting, cb) Retorna todas las ventas de un hotel en particular. Parameters: Name Type Description params object continene el hotelID,limit y offset obligatoriamente. filters object Filtros de mongo: {lastModified:1} sorting object Sorting de mongo: {lastModified:-1} cb libCB retorna un array de ventas. × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"Sorting.html":{"id":"Sorting.html","title":"Class: Sorting","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: Sorting Sorting new Sorting(map, params) Devuelve una función que convierte los path/query params de API a un objeto para ordenar en mongo. Parameters: Name Type Description map Object.&lt;string, string&gt; key value de API - Mongo Property params Object.&lt;string, string&gt; Params del request Returns: object para .sort() de mongodb. Type Object.&lt;string, number&gt; × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"Statics.html":{"id":"Statics.html","title":"Class: Statics","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: Statics Statics new Statics(server) Parameters: Name Type Description server object Hapi Server × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "},"ThemesDB.html":{"id":"ThemesDB.html","title":"Class: ThemesDB","body":" Documentation Modules configControllerEndpointLibnewrelic Classes FilterHotelCtrlHotelsHotelsDBSalesSalesCtrlSalesDBSortingStaticsThemesDB Global Global Class: ThemesDB ThemesDB new ThemesDB() Returns: Type Object × Search results Close Documentation generated by JSDoc 3.4.0 on 2016-05-27T16:58:27-03:00 using the DocStrap template. "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
